# SQL Query Examples Generated by Query Builder

This document shows example SQL queries generated by the QueryBuilderService for various search scenarios.

---

## Example 1: Simple Quick Search

**Request:**
```typescript
{
  quickSearch: 'ABC123',
  pagination: { page: 1, limit: 1000 }
}
```

**Generated SQL:**
```sql
SELECT 
  a.article_id,
  a.style,
  a.upc,
  a.description,
  a.last_modified_date,
  a.creation_date,
  a.active_code,
  a.season,
  a.label_ticket,
  av.vendor_name as primary_vendor,
  av.vendor_color as primary_vendor_color,
  avc.wholesale_price,
  avc.retail_price,
  avc.markdown_price
FROM articles a
LEFT JOIN coll c ON a.collection_id = c.collection_id
LEFT JOIN types t ON a.type_id = t.type_id
LEFT JOIN artven av ON a.article_id = av.article_id AND av.is_primary = true
LEFT JOIN artvc avc ON a.article_id = avc.article_id AND avc.vendor_id = av.vendor_id
WHERE (
  a.style LIKE $1 OR 
  a.upc LIKE $1 OR 
  a.description LIKE $1 OR 
  av.vendor_name LIKE $1
)
ORDER BY a.last_modified_date DESC
LIMIT $2
OFFSET $3
```

**Parameters:**
- `$1 = '%ABC123%'`
- `$2 = 1000`
- `$3 = 0`

**Count Query:**
```sql
SELECT COUNT(DISTINCT a.article_id) as count
FROM articles a
LEFT JOIN coll c ON a.collection_id = c.collection_id
LEFT JOIN types t ON a.type_id = t.type_id
LEFT JOIN artven av ON a.article_id = av.article_id AND av.is_primary = true
LEFT JOIN artvc avc ON a.article_id = avc.article_id AND avc.vendor_id = av.vendor_id
WHERE (
  a.style LIKE $1 OR 
  a.upc LIKE $1 OR 
  a.description LIKE $1 OR 
  av.vendor_name LIKE $1
)
```

---

## Example 2: Search with Hierarchy Filters

**Request:**
```typescript
{
  quickSearch: 'shirt',
  filters: {
    hierarchy: {
      departments: ['01', '02'],
      classes: ['A', 'B'],
      subclasses: ['X']
    }
  },
  vendorMode: 'primary',
  pagination: { page: 1, limit: 100 }
}
```

**Generated SQL:**
```sql
SELECT 
  a.article_id,
  a.style,
  a.upc,
  a.description,
  -- ... other fields ...
FROM articles a
LEFT JOIN coll c ON a.collection_id = c.collection_id
LEFT JOIN types t ON a.type_id = t.type_id
LEFT JOIN artven av ON a.article_id = av.article_id AND av.is_primary = true
LEFT JOIN artvc avc ON a.article_id = avc.article_id AND avc.vendor_id = av.vendor_id
WHERE (
  a.style LIKE $1 OR 
  a.upc LIKE $1 OR 
  a.description LIKE $1 OR 
  av.vendor_name LIKE $1
)
AND c.collection_id IN ($2, $3)
AND t.type_id IN ($4, $5)
AND a.subclass_id IN ($6)
ORDER BY a.last_modified_date DESC
LIMIT $7
OFFSET $8
```

**Parameters:**
- `$1 = '%shirt%'`
- `$2 = '01'`
- `$3 = '02'`
- `$4 = 'A'`
- `$5 = 'B'`
- `$6 = 'X'`
- `$7 = 100`
- `$8 = 0`

---

## Example 3: Search with Pricing Filters

**Request:**
```typescript
{
  filters: {
    pricing: {
      retailPrice: { min: 10, max: 50 },
      wholesalePrice: { min: 5 },
      markdownPrice: { max: 30 }
    }
  },
  vendorMode: 'primary',
  pagination: { page: 1, limit: 100 }
}
```

**Generated SQL:**
```sql
SELECT 
  -- ... fields ...
FROM articles a
LEFT JOIN coll c ON a.collection_id = c.collection_id
LEFT JOIN types t ON a.type_id = t.type_id
LEFT JOIN artven av ON a.article_id = av.article_id AND av.is_primary = true
LEFT JOIN artvc avc ON a.article_id = avc.article_id AND avc.vendor_id = av.vendor_id
WHERE 
  avc.retail_price >= $1
  AND avc.retail_price <= $2
  AND avc.wholesale_price >= $3
  AND avc.markdown_price <= $4
ORDER BY a.last_modified_date DESC
LIMIT $5
OFFSET $6
```

**Parameters:**
- `$1 = 10`
- `$2 = 50`
- `$3 = 5`
- `$4 = 30`
- `$5 = 100`
- `$6 = 0`

---

## Example 4: Search with Date Filters

**Request:**
```typescript
{
  filters: {
    dates: {
      lastModified: {
        from: new Date('2025-01-01'),
        to: new Date('2025-12-31')
      },
      creation: {
        from: new Date('2024-01-01')
      }
    }
  },
  pagination: { page: 1, limit: 100 }
}
```

**Generated SQL:**
```sql
SELECT 
  -- ... fields ...
FROM articles a
-- ... joins ...
WHERE 
  a.last_modified_date >= $1
  AND a.last_modified_date <= $2
  AND a.creation_date >= $3
ORDER BY a.last_modified_date DESC
LIMIT $4
OFFSET $5
```

**Parameters:**
- `$1 = 2025-01-01T00:00:00.000Z`
- `$2 = 2025-12-31T00:00:00.000Z`
- `$3 = 2024-01-01T00:00:00.000Z`
- `$4 = 100`
- `$5 = 0`

---

## Example 5: Secondary Vendor Mode

**Request:**
```typescript
{
  quickSearch: 'ABC',
  vendorMode: 'secondary',
  filters: {
    vendor: {
      vendorName: ['Vendor A', 'Vendor B']
    }
  },
  pagination: { page: 1, limit: 100 }
}
```

**Generated SQL:**
```sql
SELECT 
  a.article_id,
  a.style,
  a.upc,
  a.description,
  -- ... other fields ...
  av2.vendor_name as secondary_vendor,
  av2.vendor_color as secondary_vendor_color,
  avc2.wholesale_price,
  avc2.retail_price,
  avc2.markdown_price
FROM articles a
LEFT JOIN coll c ON a.collection_id = c.collection_id
LEFT JOIN types t ON a.type_id = t.type_id
LEFT JOIN artven av ON a.article_id = av.article_id AND av.is_primary = true
LEFT JOIN artven av2 ON a.article_id = av2.article_id AND av2.is_primary = false
LEFT JOIN artvc avc2 ON a.article_id = avc2.article_id AND avc2.vendor_id = av2.vendor_id
WHERE (
  a.style LIKE $1 OR 
  a.upc LIKE $1 OR 
  a.description LIKE $1 OR 
  av.vendor_name LIKE $1
)
AND av2.vendor_name IN ($2, $3)
ORDER BY a.last_modified_date DESC
LIMIT $4
OFFSET $5
```

**Parameters:**
- `$1 = '%ABC%'`
- `$2 = 'Vendor A'`
- `$3 = 'Vendor B'`
- `$4 = 100`
- `$5 = 0`

**Note:** Secondary vendor mode uses `av2` and `avc2` aliases instead of `av` and `avc`.

---

## Example 6: Complex Search with Multiple Filters

**Request:**
```typescript
{
  quickSearch: 'shirt',
  filters: {
    hierarchy: {
      departments: ['01']
    },
    pricing: {
      retailPrice: { min: 20, max: 100 }
    },
    status: {
      activeCode: ['A'],
      season: ['Spring', 'Summer']
    },
    dates: {
      lastModified: {
        from: new Date('2025-01-01')
      }
    }
  },
  sort: {
    field: 'price',
    direction: 'asc'
  },
  vendorMode: 'primary',
  pagination: { page: 2, limit: 50 }
}
```

**Generated SQL:**
```sql
SELECT 
  -- ... fields ...
FROM articles a
LEFT JOIN coll c ON a.collection_id = c.collection_id
LEFT JOIN types t ON a.type_id = t.type_id
LEFT JOIN artven av ON a.article_id = av.article_id AND av.is_primary = true
LEFT JOIN artvc avc ON a.article_id = avc.article_id AND avc.vendor_id = av.vendor_id
WHERE (
  a.style LIKE $1 OR 
  a.upc LIKE $1 OR 
  a.description LIKE $1 OR 
  av.vendor_name LIKE $1
)
AND c.collection_id IN ($2)
AND avc.retail_price >= $3
AND avc.retail_price <= $4
AND a.active_code IN ($5)
AND a.season IN ($6, $7)
AND a.last_modified_date >= $8
ORDER BY avc.retail_price ASC
LIMIT $9
OFFSET $10
```

**Parameters:**
- `$1 = '%shirt%'`
- `$2 = '01'`
- `$3 = 20`
- `$4 = 100`
- `$5 = 'A'`
- `$6 = 'Spring'`
- `$7 = 'Summer'`
- `$8 = 2025-01-01T00:00:00.000Z`
- `$9 = 50`
- `$10 = 50` (offset for page 2)

---

## Example 7: Count Query Only

**Request:**
```typescript
{
  quickSearch: 'test',
  filters: {
    hierarchy: {
      departments: ['01']
    }
  }
}
```

**Generated Count Query:**
```sql
SELECT COUNT(DISTINCT a.article_id) as count
FROM articles a
LEFT JOIN coll c ON a.collection_id = c.collection_id
LEFT JOIN types t ON a.type_id = t.type_id
LEFT JOIN artven av ON a.article_id = av.article_id AND av.is_primary = true
LEFT JOIN artvc avc ON a.article_id = avc.article_id AND avc.vendor_id = av.vendor_id
WHERE (
  a.style LIKE $1 OR 
  a.upc LIKE $1 OR 
  a.description LIKE $1 OR 
  av.vendor_name LIKE $1
)
AND c.collection_id IN ($2)
```

**Parameters:**
- `$1 = '%test%'`
- `$2 = '01'`

**Note:** Count query is optimized - no ORDER BY, LIMIT, or OFFSET.

---

## Key Features Demonstrated

1. **Parameterized Queries:** All values are passed as parameters ($1, $2, etc.) for SQL injection protection
2. **Multi-field Search:** Quick search checks style, UPC, description, and vendor name
3. **Filter Combination:** Multiple filters are combined with AND
4. **Vendor Mode:** Different table aliases for primary vs secondary vendor mode
5. **Pagination:** LIMIT and OFFSET calculated from page and limit
6. **Sorting:** ORDER BY clause based on sort configuration
7. **Optimized Count:** Separate count query without pagination/sorting

---

## Performance Considerations

- Uses indexed fields (style, upc, description) for WHERE clauses
- COUNT query is separate and optimized (no ORDER BY, LIMIT, OFFSET)
- DISTINCT in COUNT to handle joins correctly
- LEFT JOINs to preserve articles even without related data
- Parameterized queries for query plan caching

